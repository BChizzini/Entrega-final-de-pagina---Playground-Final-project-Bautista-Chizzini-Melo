from django.shortcuts import render, redirect
from django.views.generic import TemplateView, ListView, DetailView, CreateView, UpdateView, DeleteView
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from .models import Car
from .forms import CarForm


def home_view(request):
    return render(request, 'home.html')


class AboutView(TemplateView):
    template_name = 'about.html'


class CarListView(ListView):
    model = Car
    template_name = 'cars/car_list.html'
    context_object_name = 'cars'

    def get_queryset(self):
        query = self.request.GET.get('q')
        if query:
            return Car.objects.filter(marca__icontains=query) | Car.objects.filter(modelo__icontains=query)
        return Car.objects.all()


class CarDetailView(DetailView):
    model = Car
    template_name = 'cars/car_detail.html'


class CarCreateView(LoginRequiredMixin, UserPassesTestMixin, CreateView):
    model = Car
    form_class = CarForm
    template_name = 'cars/car_form.html'
    success_url = '/pages/'

    def form_valid(self, form):
        form.instance.autor = self.request.user
        return super().form_valid(form)

    def test_func(self):
        return self.request.user.profile.user_type == 'coleccionista'

    def handle_no_permission(self):
        return redirect('car_list')


class CarUpdateView(LoginRequiredMixin, UpdateView):
    model = Car
    form_class = CarForm
    template_name = 'cars/car_form.html'
    success_url = '/pages/'


class CarDeleteView(LoginRequiredMixin, UserPassesTestMixin, DeleteView):
    model = Car
    template_name = 'cars/car_confirm_delete.html'
    success_url = '/pages/'

    def test_func(self):
        car = self.get_object()
        return self.request.user.is_superuser or car.autor == self.request.user

    def handle_no_permission(self):
        return redirect('car_list')




        {% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <title>{% block title %}Portafolio de Autos{% endblock %}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <style>
      .avatar-navbar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        margin-left: 15px;
      }
      .logout-btn {
        color: white;
        background-color: #dc3545;
        border: none;
        padding: 10px 20px;
        width: 100%;
        text-align: center;
        font-weight: bold;
        border-radius: 5px;
      }
      .logout-btn:hover {
        background-color: #bb2d3b;
        color: white;
      }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="{% url 'home' %}">Portafolio Autos</a>
    <div class="navbar-nav ms-auto d-flex align-items-center">
        <a class="nav-link" href="{% url 'home' %}">Home</a>
        <a class="nav-link" href="{% url 'about' %}">Acerca de mí</a>
        <a class="nav-link" href="{% url 'car_list' %}">Autos</a>
        {% if user.is_authenticated %}
            <a class="nav-link" href="{% url 'messaging_inbox' %}">Mensajes</a>
            {% if user.profile %}
                {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="avatar" class="avatar-navbar" data-toggle="modal" data-target="#profileModal" title="{{ user.username }}">
                {% else %}
                    <img src="{% static 'default_avatar.png' %}" alt="avatar por defecto" class="avatar-navbar" data-toggle="modal" data-target="#profileModal" title="{{ user.username }}">
                {% endif %}
            {% else %}
                <img src="{% static 'default_avatar.png' %}" alt="avatar por defecto" class="avatar-navbar" data-toggle="modal" data-target="#profileModal" title="{{ user.username }}">
            {% endif %}
        {% else %}
            <a class="nav-link" href="{% url 'login' %}">Login</a>
            <a class="nav-link" href="{% url 'signup' %}">Signup</a>
        {% endif %}
    </div>
</nav>

<div class="container mt-4">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger">{{ message }}</div>
        {% endfor %}
    {% endif %}
    {% block content %}{% endblock %}
</div>


<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-dark">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">{{ user.username }} - {{ user.profile.get_user_type_display }}</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        {% if user.profile %}
            {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="rounded-circle mb-3" style="width:120px; height:120px; object-fit:cover;">
            {% else %}
                <img src="{% static 'default_avatar.png' %}" alt="Avatar por defecto" class="rounded-circle mb-3" style="width:120px; height:120px; object-fit:cover;">
            {% endif %}
        {% else %}
            <img src="{% static 'default_avatar.png' %}" alt="Avatar por defecto" class="rounded-circle mb-3" style="width:120px; height:120px; object-fit:cover;">
        {% endif %}
        <p><strong>Biografía:</strong> {{ user.profile.bio|default:"No has agregado una biografía." }}</p>
        <hr>
        <h6>Likes</h6>
        <ul>
          {% for like in user.like_set.all %}
            <li>{{ like.car.marca }} {{ like.car.modelo }}</li>
          {% empty %}
            <li>No tienes likes aún.</li>
          {% endfor %}
        </ul>
        <h6>Comentarios</h6>
        <ul>
          {% for comment in user.comment_set.all %}
            <li><strong>{{ comment.car.marca }} {{ comment.car.modelo }}:</strong> {{ comment.content }}</li>
          {% empty %}
            <li>No tienes comentarios aún.</li>
          {% endfor %}
        </ul>
        <a href="{% url 'profile' %}" class="btn btn-primary w-100 mb-2">Editar Perfil</a>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="logout-btn mt-3">Cerrar Sesión</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  $(document).on('click', '#like-btn', function() {
  var carId = $(this).data('car-id');
  $.ajax({
    url: '/likes/like/' + carId + '/',
    type: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    success: function(data) {
      $('#like-btn').text('Like (' + data.likes + ')');
    },
    error: function(xhr) {
      if(xhr.status === 403 || xhr.status === 401) {
        alert('Debes iniciar sesión para poder dar like.');
        window.location.href = "{% url 'login' %}";
      } else {
        alert('Ocurrió un error al procesar tu like.');
      }
    }
  });
});

</script>

</body>
</html>